<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentence Practice (All)</title>
    <link rel="stylesheet" href="css/Sstyles.css">
    <style>
        @font-face {
            font-family: 'Tegaki';
            src: url('font/tegaki.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        .tegaki-font {
            font-family: 'Tegaki', sans-serif;
        }

        @font-face {
            font-family: 'ZenOldMincho';
            src: url('font/ZenOldMincho-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        .mincho-font {
            font-family: 'ZenOldMincho', serif;
        }

        @font-face {
            font-family: 'ZenMaruGothic';
            src: url('font/ZenMaruGothic-Regular.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        .marugothic-font {
            font-family: 'ZenMaruGothic', sans-serif;
        }

        /* Bottom + horizontal history panel */
        body {
            overflow-x: hidden;
        }

        #app {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
        }

        #main-content {
            flex: 1 1 auto;
            /* Disable reserved space for the old fixed sidebar */
            padding-bottom: 0 !important;
        }

        #sidebar {
            width: 100%;
            box-sizing: border-box;
            max-height: 370px;
            overflow: hidden;
            /* Disable old fixed/sticky sidebar layout from Sstyles.css */
            position: static !important;
            height: auto !important;
        }

        #stats-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 16px;
            align-items: center;
            margin-bottom: 8px;
        }

        #history-list {
            display: flex;
            flex-direction: row;
            gap: 10px;
            padding: 0;
            margin: 0;
            list-style: none;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
        }

        #history-list li {
            flex: 0 0 auto;
            width: min(520px, 86vw);
            box-sizing: border-box;
        }

        #history-list li .kanji,
        #history-list li .details {
            word-break: break-word;
        }

        /* Sstyles.css switches body into a 2-column grid on wide screens.
           Our history is nested under #app, so that grid leaves an empty right column.
           Force normal flow on wide screens. */
        @media (min-width: 900px) {
            body {
                display: block !important;
            }
        }
    </style>
</head>
<body class="dark-mode">
    <header id="top-bar" aria-label="App controls">
        <button id="theme-toggle" type="button">Toggle Light Mode</button>
        <div id="volume-control" aria-label="Volume controls">
            <button id="volume-toggle" type="button">Mute</button>
            <label class="sr-only" for="volume-slider">Volume</label>
            <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1" aria-label="Volume">
        </div>
    </header>

    <div id="level-selector" role="dialog" aria-modal="true" aria-label="Quiz setup">
        <div>
            <h2>Select JLPT Level</h2>
            <select id="jlpt-level">
                <!-- <option value="N5">N5 KANJI VOCABULARY</option>
                <option value="N4">N4 KANJI VOCABULARY</option> -->
                <option value="N3">N3 KANJI VOCABULARY</option>
            </select>
            <h2>Select Mode</h2>
            <select id="quiz-mode">
                <option value="normal">Normal (Complete All)</option>
                <option value="endless">Endless (Repeat)</option>
            </select>
            <h2>Voice Input</h2>
            <label><input type="checkbox" id="voice-input-toggle-start"> Enable Voice Input (Japanese)</label>
            <br>
            <button id="start-btn" type="button">Start Quiz</button>
        </div>
    </div>

    <div id="app">
    <div id="main-content">
        <div id="difficulty-switcher">
            <span id="timer">Time: 00:00</span>
            <select id="difficulty-switch">
                <!-- <option value="N5">N5 KANJI VOCABULARY</option> -->
                <!-- <option value="N4">N4 KANJI VOCABULARY</option> -->
                <option value="N3">N3 KANJI VOCABULARY</option>
            </select>
            <select id="mode-switch">
                <option value="normal">Normal (Complete All)</option>
                <option value="endless">Endless (Repeat)</option>
            </select>
            <label><input type="checkbox" id="voice-input-toggle"> Voice Input (Japanese)</label>
            <button id="speak-now-btn" type="button">Speak Now</button>
            <select id="font-switch">
                <option value="mincho" selected>Mincho Font</option>
                <option value="default">Default Font</option>
                <option value="marugothic">Maru Gothic Font</option>
                <option value="tegaki">Tegaki Font</option>
            </select>
        </div>
        <button id="reset-button" type="button">Reset Quiz</button>
        <div id="kanji-display" class="mincho-font"></div>
        <input type="text" id="answer-input" placeholder="Type kanji / kana / meaning" aria-label="Answer" autocomplete="off" autocapitalize="off" spellcheck="false">
        <div id="feedback" aria-live="polite" aria-atomic="true"></div>
        <div id="font-size-control"></div>
    </div>

    <div id="sidebar">
        <h3>Last 6 Attempts</h3>
        <div id="stats-container">
            <span id="current-mode">Mode: </span>
            <span id="correct-count">Correct: 0</span>
            <span id="remaining-count">All: 0</span>
        </div>
        <ul id="history-list"></ul>
    </div>
    </div>

    <audio id="correct-sound" src="soundeffects/correct.mp3"></audio>
    <audio id="wrong-sound" src="soundeffects/wrong.mp3"></audio>

    
    <script src="Data/sentences/JPsentence.js"></script>
    <!-- <script src="Data/n5sentence.js"></script>
    <script src="Data/n4sentence.js"></script> -->
    <script src="Data/sentences/n3sentence.js"></script>

    <script>
        let currentLevel = 'N5';
        let currentKanjiList = [];
        let currentKanjiIndex = 0;
        let answerHistory = [];
        let correctCount = 0;
        let totalCount = 0;
        let correctlyAnswered = new Set();
        let timerInterval = null;
        let elapsedTime = 0;
        let isMuted = false;
        let quizMode = 'normal';
        let isVoiceInputEnabled = false;
        let fontSize = 60;

        const correctSound = document.getElementById('correct-sound');
        const wrongSound = document.getElementById('wrong-sound');

        // Voice recognition setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
        } else {
            document.getElementById('voice-input-toggle-start').disabled = true;
            document.getElementById('voice-input-toggle-start').title = 'Voice input not supported in this browser';
            document.getElementById('voice-input-toggle').disabled = true;
            document.getElementById('voice-input-toggle').title = 'Voice input not supported in this browser';
            document.getElementById('speak-now-btn').disabled = true;
            document.getElementById('speak-now-btn').title = 'Voice input not supported in this browser';
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                elapsedTime++;
                document.getElementById('timer').textContent = `Time: ${formatTime(elapsedTime)}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function resetTimer() {
            stopTimer();
            elapsedTime = 0;
            document.getElementById('timer').textContent = `Time: ${formatTime(elapsedTime)}`;
        }

        function playSound(type) {
            if (!isMuted) {
                const sound = type === 'correct' ? correctSound : wrongSound;
                sound.currentTime = 0;
                sound.play().catch(() => {});
            }
        }

        function displayKanji() {
            if (quizMode === 'normal' && currentKanjiList.length === 0) {
                const percentage = totalCount > 0 ? (correctCount / totalCount * 100).toFixed(0) : 0.00;
                document.getElementById("kanji-display").textContent = `${percentage}%`;
                document.getElementById("answer-input").style.display = "none";
                document.getElementById("voice-input-toggle").style.display = "none";
                document.getElementById("speak-now-btn").style.display = "none";
                document.getElementById("font-switch").style.display = "none";
                document.getElementById("font-size-control").style.display = "none";
                document.getElementById("feedback").textContent = "Quiz completed!";
                stopTimer();
                if (recognition && isVoiceInputEnabled) {
                    recognition.stop();
                }
                return;
            }
            if (quizMode === 'endless' && currentKanjiList.length === 0) {
                currentKanjiList = shuffle([...kanjiData[currentLevel]]);
                currentKanjiIndex = 0;
            }
            const kanji = currentKanjiList[currentKanjiIndex];
            document.getElementById("kanji-display").textContent = kanji.kanji;
            document.getElementById("kanji-display").style.fontSize = `${fontSize}px`;
            document.getElementById("answer-input").value = "";
            document.getElementById("feedback").textContent = "";
            document.getElementById("answer-input").focus();
            document.getElementById("speak-now-btn").style.display = isVoiceInputEnabled ? "inline-block" : "none";
            document.getElementById("font-switch").style.display = "inline-block";
            document.getElementById("font-size-control").style.display = "block";
        }

        function updateHistory() {
            const historyList = document.getElementById("history-list");
            historyList.textContent = "";
            answerHistory.slice(-3).forEach(entry => {
                const li = document.createElement("li");
                li.className = entry.result === "Correct" ? "correct" : "incorrect";

                const kanjiSpan = document.createElement("span");
                kanjiSpan.className = "kanji";
                kanjiSpan.textContent = entry.kanji;

                const detailsSpan = document.createElement("span");
                detailsSpan.className = "details";

                const answerSpan = document.createElement("span");
                answerSpan.className = "answer";
                answerSpan.textContent = entry.answer;

                const meaningsSpan = document.createElement("span");
                meaningsSpan.className = "meanings";
                meaningsSpan.textContent = (entry.meanings || []).filter(Boolean).join(" / ") || "None";

                const readingsSpan = document.createElement("span");
                readingsSpan.className = "readings";
                readingsSpan.textContent = (entry.readings || []).join(", ");

                detailsSpan.appendChild(answerSpan);
                detailsSpan.appendChild(document.createElement("br"));
                detailsSpan.appendChild(meaningsSpan);
                detailsSpan.appendChild(document.createElement("br"));
                detailsSpan.appendChild(readingsSpan);

                li.appendChild(kanjiSpan);
                li.appendChild(detailsSpan);
                historyList.appendChild(li);
            });
            historyList.scrollLeft = historyList.scrollWidth;
        }

        function updateStats() {
            document.getElementById("current-mode").textContent = `Current Mode: ${quizMode}`;
            document.getElementById("correct-count").textContent = `Correct: ${correctCount}`;
            document.getElementById("remaining-count").textContent = `All: ${currentKanjiList.length}`;
        }

        function normalizeInput(input) {
            return input.replace(/[\s.,!?;:'"()、。・？]/g, '').trim();
        }

        function checkAnswer(userAnswer, isVoiceInput = false) {
            const kanji = currentKanjiList[currentKanjiIndex];
            const correctReadings = kanji.readings.map(normalizeInput);
            const correctMeanings = kanji.meanings.map(normalizeInput);
            const correctKanji = normalizeInput(kanji.kanji);
            const normalizedUserAnswer = normalizeInput(userAnswer);

            let result;
            const isCorrect = isVoiceInput
                ? (normalizedUserAnswer === correctKanji || correctReadings.includes(normalizedUserAnswer))
                : (normalizedUserAnswer === correctKanji || correctReadings.includes(normalizedUserAnswer) || correctMeanings.includes(normalizedUserAnswer));

            if (isCorrect) {
                result = "Correct";
                document.getElementById("feedback").textContent = "Correct!";
                document.getElementById("feedback").style.color = "green";
                correctCount++;
                correctlyAnswered.add(kanji.kanji);
                if (quizMode === 'normal') {
                    currentKanjiList.splice(currentKanjiIndex, 1);
                    if (currentKanjiIndex >= currentKanjiList.length) {
                        currentKanjiIndex = 0;
                    }
                } else {
                    currentKanjiIndex = (currentKanjiIndex + 1) % currentKanjiList.length;
                }
                playSound('correct');
            } else {
                result = "Incorrect";
                document.getElementById("feedback").textContent =
                    `Incorrect. Character: ${correctKanji}, Readings: ${correctReadings.join(", ")}, Meanings: ${correctMeanings.join(", ")}`;
                document.getElementById("feedback").style.color = "red";
                currentKanjiIndex = (currentKanjiIndex + 1) % currentKanjiList.length;
                playSound('wrong');
            }

            totalCount++;
            answerHistory.push({
                kanji: kanji.kanji,
                answer: userAnswer || "(empty)",
                meanings: kanji.meanings,
                readings: kanji.readings,
                result: result
            });

            updateHistory();
            updateStats();

            setTimeout(displayKanji, 1);
        }

        function resetQuiz() {
            currentKanjiList = shuffle([...kanjiData[currentLevel]]);
            currentKanjiIndex = 0;
            answerHistory = [];
            correctCount = 0;
            totalCount = 0;
            correctlyAnswered.clear();
            updateHistory();
            updateStats();
            document.getElementById("answer-input").style.display = "block";
            document.getElementById("voice-input-toggle").style.display = "inline-block";
            document.getElementById("speak-now-btn").style.display = isVoiceInputEnabled ? "inline-block" : "none";
            document.getElementById("font-switch").style.display = "inline-block";
            document.getElementById("font-size-control").style.display = "block";
            resetTimer();
            startTimer();
            displayKanji();
        }

        function startQuiz(level, mode) {
            currentLevel = level;
            quizMode = mode;
            isVoiceInputEnabled = document.getElementById("voice-input-toggle-start").checked;
            document.getElementById("voice-input-toggle").checked = isVoiceInputEnabled;
            document.getElementById("speak-now-btn").style.display = isVoiceInputEnabled ? "inline-block" : "none";
            document.getElementById("font-switch").style.display = "inline-block";
            document.getElementById("font-size-control").style.display = "block";

            if (!kanjiData || !kanjiData[level] || !Array.isArray(kanjiData[level]) || kanjiData[level].length === 0) {
                document.getElementById("feedback").textContent = `No sentences loaded for ${level}. Check your Data/*_generated.js script tags.`;
                document.getElementById("feedback").style.color = "red";
                return;
            }

            currentKanjiList = shuffle([...kanjiData[level]]);
            currentKanjiIndex = 0;
            answerHistory = [];
            correctCount = 0;
            totalCount = 0;
            correctlyAnswered.clear();
            updateHistory();
            updateStats();
            document.getElementById("level-selector").style.display = "none";
            document.getElementById("main-content").style.display = "flex";
            document.getElementById("sidebar").style.display = "block";
            document.getElementById("difficulty-switch").value = level;
            document.getElementById("mode-switch").value = mode;
            resetTimer();
            startTimer();
            displayKanji();
        }

        document.getElementById("font-switch").addEventListener("change", function() {
            const selectedFont = this.value;
            const kanjiDisplay = document.getElementById("kanji-display");
            kanjiDisplay.classList.remove('marugothic-font', 'mincho-font', 'tegaki-font');
            if (selectedFont === 'marugothic') {
                kanjiDisplay.classList.add('marugothic-font');
            } else if (selectedFont === 'mincho') {
                kanjiDisplay.classList.add('mincho-font');
            } else if (selectedFont === 'tegaki') {
                kanjiDisplay.classList.add('tegaki-font');
            }
        });

        // Apply default font (Mincho) on load.
        document.getElementById("font-switch").dispatchEvent(new Event('change'));

        if (recognition) {
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript.trim();
                document.getElementById("answer-input").value = transcript;
                document.getElementById("feedback").textContent = "";
                checkAnswer(transcript, true);
            };

            recognition.onerror = function(event) {
                document.getElementById("feedback").textContent = "Voice input error: " + event.error;
                document.getElementById("feedback").style.color = "red";
            };

            recognition.onend = function() {
                document.getElementById("feedback").textContent = "";
            };

            document.getElementById("voice-input-toggle").addEventListener("change", function() {
                isVoiceInputEnabled = this.checked;
                document.getElementById("speak-now-btn").style.display = isVoiceInputEnabled ? "inline-block" : "none";
                if (!isVoiceInputEnabled && recognition) {
                    recognition.stop();
                    document.getElementById("feedback").textContent = "";
                }
            });

            document.getElementById("voice-input-toggle-start").addEventListener("change", function() {
                isVoiceInputEnabled = this.checked;
            });

            document.getElementById("speak-now-btn").addEventListener("click", function() {
                if (isVoiceInputEnabled && recognition && currentKanjiList.length > 0) {
                    try {
                        recognition.start();
                        document.getElementById("feedback").textContent = "Listening for Japanese...";
                        document.getElementById("feedback").style.color = "blue";
                    } catch (error) {
                        document.getElementById("feedback").textContent = "Voice input error: " + error.message;
                        document.getElementById("feedback").style.color = "red";
                    }
                }
            });
        }

        document.getElementById("difficulty-switch").addEventListener("change", function() {
            startQuiz(this.value, quizMode);
        });

        document.getElementById("mode-switch").addEventListener("change", function() {
            quizMode = this.value;
            if (quizMode === 'endless' && currentKanjiList.length === 0) {
                currentKanjiList = shuffle([...kanjiData[currentLevel]]);
                currentKanjiIndex = 0;
                document.getElementById("answer-input").style.display = "block";
                document.getElementById("voice-input-toggle").style.display = "inline-block";
                document.getElementById("speak-now-btn").style.display = isVoiceInputEnabled ? "inline-block" : "none";
                document.getElementById("font-switch").style.display = "inline-block";
                document.getElementById("font-size-control").style.display = "block";
                document.getElementById("feedback").textContent = "";
                startTimer();
                displayKanji();
            } else if (quizMode === 'normal' && currentKanjiList.length === 0) {
                const percentage = totalCount > 0 ? (correctCount / totalCount * 100).toFixed(0) : 0.00;
                document.getElementById("kanji-display").textContent = `${percentage}%`;
                document.getElementById("answer-input").style.display = "none";
                document.getElementById("voice-input-toggle").style.display = "none";
                document.getElementById("speak-now-btn").style.display = "none";
                document.getElementById("font-switch").style.display = "none";
                document.getElementById("font-size-control").style.display = "none";
                document.getElementById("feedback").textContent = "Quiz completed!";
                stopTimer();
            }
        });

        document.getElementById("start-btn").addEventListener("click", function() {
            const selectedLevel = document.getElementById("jlpt-level").value;
            const selectedMode = document.getElementById("quiz-mode").value;
            startQuiz(selectedLevel, selectedMode);
        });

        document.getElementById("answer-input").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                if (isVoiceInputEnabled && recognition) {
                    recognition.stop();
                }
                checkAnswer(this.value.trim(), false);
            }
        });

        document.getElementById("theme-toggle").addEventListener("click", function() {
            document.body.classList.toggle("dark-mode");
            this.textContent = document.body.classList.contains("dark-mode") ?
                "Toggle Light Mode" : "Toggle Dark Mode";
        });

        document.getElementById("reset-button").addEventListener("click", function() {
            if (isVoiceInputEnabled && recognition) {
                recognition.stop();
            }
            resetQuiz();
        });

        document.getElementById("volume-toggle").addEventListener("click", function() {
            isMuted = !isMuted;
            this.textContent = isMuted ? "Unmute" : "Mute";
            correctSound.volume = isMuted ? 0 : document.getElementById("volume-slider").value;
            wrongSound.volume = isMuted ? 0 : document.getElementById("volume-slider").value;
        });

        document.getElementById("volume-slider").addEventListener("input", function() {
            const volume = this.value;
            correctSound.volume = isMuted ? 0 : volume;
            wrongSound.volume = isMuted ? 0 : volume;
        });

        document.addEventListener("keydown", function(event) {
            if (event.key === "Enter" && quizMode === 'normal' && currentKanjiList.length === 0) {
                resetQuiz();
            }
        });

        document.getElementById("main-content").style.display = "none";
        document.getElementById("sidebar").style.display = "none";
    </script>
</body>
</html>
