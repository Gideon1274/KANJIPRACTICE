<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOCABULARY</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        @font-face {
            font-family: 'Tegaki';
            src: url('font/tegaki.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        .tegaki-font {
            font-family: 'Tegaki', sans-serif;
        }

        @font-face {
            font-family: 'mincho';
            src: url('font/mincho.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        .mincho-font {
            font-family: 'mincho', serif;
        }
        @font-face {
            font-family: 'marugothic';
            src: url('font/marugothic.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        .marugothic-font {
            font-family: 'marugothic', sans-serif;
        }
        /* Left history sidebar */
        #sidebar {
            display: none; /* shown after start */
            width: 360px;
            box-sizing: border-box;
            padding: 10px;
        }
        /* Fixed vocab panel on the far right of the page */
        #vocab-panel {
            display: none; /* hidden until a difficulty is picked */
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 300px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 10px;
            box-sizing: border-box;
            overflow: auto;
            z-index: 999;
        }
        #vocab-panel h3 { margin-top: 0; }
        #vocab-panel input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 8px;
        }
        #vocab-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: calc(100vh - 120px);
            overflow: auto;
        }
        #vocab-list li {
            padding: 4px 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        /* visually dim unchecked items but keep them visible in the checklist */
        #vocab-list li.disabled { opacity: 0.45; }

        /* when vocab panel is open, add right padding so top controls don't get overlapped */
        .vocab-open { padding-right: 300px; }
        
        
        
    </style>
</head>
<body class="dark-mode">
    <button id="theme-toggle">Toggle Light Mode</button>
    <div id="volume-control">
        <button id="volume-toggle">Mute</button>
        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1">
    </div>
    <div id="level-selector">
        <div>
            <h2>Select Kana Level</h2>
            <select id="jlpt-level">
                <!-- <option value="N5">N5 KANJI VOCABULARY</option> -->
                <!-- <option value="N4">N4 KANJI VOCABULARY</option> -->
                <option value="N3">N3 KANJI VOCABULARY</option>
                <option value="N2">N2 KANJI VOCABULARY</option>
                <option value="N1">N1 KANJI VOCABULARY</option>
            </select>
            <h2>Select Mode</h2>
            <select id="quiz-mode">
                <option value="normal">Normal (Complete All)</option>
                <option value="endless">Endless (Repeat)</option>
            </select>
            <h2>Voice Input</h2>
            <label><input type="checkbox" id="voice-input-toggle-start"> Enable Voice Input (Japanese)</label>
            <br>
            <button id="start-btn">Start Quiz</button>
        </div>
    </div>
    <div id="sidebar">
        <h3>Previous 6 Attempts (History)</h3>
        <div id="stats-container">
            <span id="current-mode">Mode: </span>
            <span id="correct-count">Correct: 0</span>
            <span id="remaining-count">All: 0</span>
        </div>
        <ul id="history-list"></ul>
    </div>

    <!-- Fixed panel on the far right for the vocab/kanji checklist -->
    <div id="vocab-panel" aria-label="Vocab Checklist">
        <h3>Vocab / Kanji (Checklist)</h3>
        <input type="text" id="vocab-range-input" placeholder="Enter ranges, e.g. 1-25,40-50 and press Enter">
        <ul id="vocab-list"></ul>
    </div>
    <div id="main-content">
        <div id="difficulty-switcher">
            <span id="timer">Time: 00:00</span>
            <select id="difficulty-switch">
                <option value="N5">N5 KANJI VOCABULARY</option>
                <option value="N4">N4 KANJI VOCABULARY</option>
                <option value="N3">N3 KANJI VOCABULARY</option>
                <option value="N2">N2 KANJI VOCABULARY</option>
                <option value="N1">N1 KANJI VOCABULARY</option>
            </select>
            <select id="mode-switch">
                <option value="normal">Normal (Complete All)</option>
                <option value="endless">Endless (Repeat)</option>
            </select>
            <label><input type="checkbox" id="voice-input-toggle"> Voice Input (Japanese)</label>
            <button id="speak-now-btn">Speak Now</button>
            <select id="font-switch">
                <option value="mincho" selected>Mincho Font</option>
                <option value="default">Default Font</option>
                <option value="marugothic">Maru Gothic Font</option>
                <option value="tegaki">Tegaki Font</option>
                
            </select>
        </div>
        <button id="reset-button">Reset Quiz</button>
        <div id="kanji-display" class="mincho-font"></div>
        <input type="text" id="answer-input" placeholder="Type character or romaji">
        <div id="feedback"></div>
        <div id="font-size-control">
            <button id="decrease-font">-</button>
            <button id="increase-font">+</button>
        </div>
    </div>
    <audio id="correct-sound" src="soundeffects/correct.mp3"></audio>
    <audio id="wrong-sound" src="soundeffects/wrong.mp3"></audio>

    <!-- <script src="Data/asd.js"></script> -->
    <script src="Data/kanji/Nkanji3.js"></script>
    <script src="Data/kanji/Nkanji1.js"></script>
    <!-- <script src="Data/all.js"></script> -->
    
    <script>
        let currentLevel = 'N5';
        let currentKanjiList = [];
        let currentKanjiIndex = 0;
        let answerHistory = [];
        let correctCount = 0;
        let totalCount = 0;
        let correctlyAnswered = new Set();
        let timerInterval = null;
        let elapsedTime = 0;
        let isMuted = false;
        let quizMode = 'normal';
        let isVoiceInputEnabled = false;
        let fontSize = 90; 

        // Endless mode: track the last completed cycle order so the next shuffle
        // can't repeat the exact same sequence.
        let lastEndlessOrderKey = null;

        const correctSound = document.getElementById('correct-sound');
        const wrongSound = document.getElementById('wrong-sound');

        // Voice recognition setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP'; // Set to Japanese
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;
            console.log('SpeechRecognition initialized with lang: ja-JP');
        } else {
            document.getElementById('voice-input-toggle-start').disabled = true;
            document.getElementById('voice-input-toggle-start').title = 'Voice input not supported in this browser';
            document.getElementById('voice-input-toggle').disabled = true;
            document.getElementById('voice-input-toggle').title = 'Voice input not supported in this browser';
            document.getElementById('speak-now-btn').disabled = true;
            document.getElementById('speak-now-btn').title = 'Voice input not supported in this browser';
            console.log('SpeechRecognition not supported in this browser');
        }

        function shuffle(array) {
            console.log('Shuffling array of length:', array.length);
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getOrderKey(list) {
            return (list || []).map(item => item && item.kanji ? item.kanji : '').join('|');
        }

        function reshuffleEndlessCycle() {
            const base = getKanjiDataForLevel(currentLevel);
            if (base.length === 0) {
                currentKanjiList = [];
                currentKanjiIndex = 0;
                lastEndlessOrderKey = null;
                correctlyAnswered.clear();
                return;
            }

            const maxAttempts = 30;
            let nextList = null;
            let nextKey = null;
            for (let attempt = 0; attempt < maxAttempts; attempt++) {
                const candidate = shuffle([...base]);
                const candidateKey = getOrderKey(candidate);
                if (base.length <= 1 || candidateKey !== lastEndlessOrderKey) {
                    nextList = candidate;
                    nextKey = candidateKey;
                    break;
                }
            }

            // Fallback (very small chance): accept the last candidate.
            if (!nextList) {
                nextList = shuffle([...base]);
                nextKey = getOrderKey(nextList);
            }

            currentKanjiList = nextList;
            currentKanjiIndex = 0;
            correctlyAnswered.clear();
            lastEndlessOrderKey = nextKey;
            console.log('Endless mode: New cycle reshuffled');
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                elapsedTime++;
                document.getElementById('timer').textContent = `Time: ${formatTime(elapsedTime)}`;
            }, 1000);
            console.log('Timer started');
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            console.log('Timer stopped');
        }

        function resetTimer() {
            stopTimer();
            elapsedTime = 0;
            document.getElementById('timer').textContent = `Time: ${formatTime(elapsedTime)}`;
            console.log('Timer reset');
        }

        function playSound(type) {
            console.log(`Attempting to play ${type} sound, muted: ${isMuted}`);
            if (!isMuted) {
                const sound = type === 'correct' ? correctSound : wrongSound;
                sound.currentTime = 0;
                sound.play().catch(error => console.error('Error playing sound:', error));
            }
        }

        function displayKanji() {
            console.log('Displaying kanji, quizMode:', quizMode, 'kanjiList length:', currentKanjiList.length);
            if (quizMode === 'normal' && currentKanjiList.length === 0) {
                const percentage = totalCount > 0 ? (correctCount / totalCount * 100).toFixed(0) : 0.00;
                document.getElementById("kanji-display").textContent = `${percentage}%`;
                document.getElementById("answer-input").style.display = "none";
                document.getElementById("voice-input-toggle").style.display = "none";
                document.getElementById("speak-now-btn").style.display = "none";
                document.getElementById("font-switch").style.display = "none";
                document.getElementById("font-size-control").style.display = "none";
                document.getElementById("feedback").textContent = "Quiz completed!";
                stopTimer();
                if (recognition && isVoiceInputEnabled) {
                    recognition.stop();
                }
                return;
            }
            if (quizMode === 'endless' && currentKanjiList.length === 0) {
                reshuffleEndlessCycle();
                console.log('Endless mode: Reset kanji list');
            }
            const kanji = currentKanjiList[currentKanjiIndex];
            document.getElementById("kanji-display").textContent = kanji.kanji;
            document.getElementById("kanji-display").style.fontSize = `${fontSize}px`;
            document.getElementById("answer-input").value = "";
            document.getElementById("feedback").textContent = "";
            document.getElementById("answer-input").focus();
            document.getElementById("speak-now-btn").style.display = isVoiceInputEnabled ? "inline-block" : "none";
            document.getElementById("font-switch").style.display = "inline-block";
            document.getElementById("font-size-control").style.display = "block";
        }

        function updateHistory() {
            console.log('Updating history, answerHistory length:', answerHistory.length);
            const historyList = document.getElementById("history-list");
            historyList.innerHTML = "";
            answerHistory.slice(-6).forEach(entry => {
                const li = document.createElement("li");
                li.innerHTML = `
                    <span class="kanji">${entry.kanji}</span>
                    <span class="details">
                        Input: ${entry.answer}<br>
                        Meaning: ${entry.meanings.filter(m => m).join(", ") || "None"}<br>
                        Readings: ${entry.readings.join(", ")}
                    </span>`;
                li.className = entry.result === "Correct" ? "correct" : "incorrect";
                historyList.appendChild(li);
            });
            historyList.scrollTop = historyList.scrollHeight;
        }

        function updateStats() {
            document.getElementById("current-mode").textContent = `Current Mode: ${quizMode}`;
            document.getElementById("correct-count").textContent = `Correct: ${correctCount}`;
            document.getElementById("remaining-count").textContent = `All: ${currentKanjiList.length}`;
            console.log('Stats updated: Mode:', quizMode, 'Correct:', correctCount, 'Remaining:', currentKanjiList.length);
        }

        function normalizeInput(input) {
            return input.replace(/[\s.,!?;:'"()、。・？]/g, '').trim();
        }

        function checkAnswer(userAnswer, isVoiceInput = false) {
            console.log('Checking answer:', userAnswer, 'isVoiceInput:', isVoiceInput);
            const kanji = currentKanjiList[currentKanjiIndex];
            const correctReadings = kanji.readings.map(normalizeInput);
            const correctMeanings = kanji.meanings.map(normalizeInput);
            const correctKanji = normalizeInput(kanji.kanji);
            const normalizedUserAnswer = normalizeInput(userAnswer);

            let result;
            const isCorrect = isVoiceInput 
                ? (normalizedUserAnswer === correctKanji || correctReadings.includes(normalizedUserAnswer))
                : (normalizedUserAnswer === correctKanji || correctReadings.includes(normalizedUserAnswer) || correctMeanings.includes(normalizedUserAnswer));
            
            if (isCorrect) {
                result = "Correct";
                document.getElementById("feedback").textContent = "Correct!";
                document.getElementById("feedback").style.color = "green";
                correctCount++;
                correctlyAnswered.add(kanji.kanji);
                if (quizMode === 'normal') {
                    currentKanjiList.splice(currentKanjiIndex, 1);
                    if (currentKanjiIndex >= currentKanjiList.length) {
                        currentKanjiIndex = 0;
                    }
                } else {
                    const totalInLevel = getKanjiDataForLevel(currentLevel).length;
                    if (totalInLevel > 0 && correctlyAnswered.size >= totalInLevel) {
                        reshuffleEndlessCycle();
                    } else {
                        currentKanjiIndex = (currentKanjiIndex + 1) % currentKanjiList.length;
                    }
                }
                playSound('correct');
            } else {
                result = "Incorrect";
                document.getElementById("feedback").textContent = 
                    `Incorrect. Character: ${correctKanji}, Readings: ${correctReadings.join(", ")}, Meanings: ${correctMeanings.join(", ")}`;
                document.getElementById("feedback").style.color = "red";
                currentKanjiIndex = (currentKanjiIndex + 1) % currentKanjiList.length;
                playSound('wrong');
            }

            totalCount++;
            answerHistory.push({
                kanji: kanji.kanji,
                answer: userAnswer || "(empty)",
                meanings: kanji.meanings,
                readings: kanji.readings,
                result: result
            });

            updateHistory();
            updateStats();

            setTimeout(displayKanji, 1);
        }

        function getKanjiDataForLevel(level) {
            const data = window.kanjiData || {};
            const list = data[level];
            if (!Array.isArray(list)) {
                console.warn('No kanji data found for level:', level);
                return [];
            }
            return list;
        }

        // Build the checklist on the right side showing only the kanji/vocab (no readings/meanings)
        function buildVocabList() {
            const listContainer = document.getElementById('vocab-list');
            listContainer.innerHTML = '';
            const base = getKanjiDataForLevel(currentLevel) || [];
            base.forEach((item, idx) => {
                const li = document.createElement('li');
                const number = idx + 1;
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.id = `vocab-checkbox-${number}`;
                cb.checked = true;
                cb.dataset.idx = idx;
                cb.addEventListener('change', (e) => {
                    if (cb.checked) li.classList.remove('disabled');
                    else li.classList.add('disabled');
                });
                const label = document.createElement('label');
                label.htmlFor = cb.id;
                label.textContent = `${number}. ${item.kanji}`;
                li.appendChild(cb);
                li.appendChild(label);
                listContainer.appendChild(li);
            });
        }

        // Parse range string like "1-25,40-50" into a Set of 1-based indices
        function parseRanges(rangeStr, max) {
            const out = new Set();
            if (!rangeStr) return out;
            const parts = rangeStr.split(',').map(p => p.trim()).filter(Boolean);
            parts.forEach(part => {
                if (part.includes('-')) {
                    const [a,b] = part.split('-').map(x => parseInt(x.trim(),10));
                    if (!isNaN(a) && !isNaN(b)) {
                        const start = Math.max(1, Math.min(a,b));
                        const end = Math.min(max, Math.max(a,b));
                        for (let i = start; i <= end; i++) out.add(i);
                    }
                } else {
                    const n = parseInt(part,10);
                    if (!isNaN(n) && n >= 1 && n <= max) out.add(n);
                }
            });
            return out;
        }

        // Apply range filter: check only numbers in the set, uncheck others (keep all visible)
        function applyRangeFilter(rangeStr) {
            const base = getKanjiDataForLevel(currentLevel) || [];
            const max = base.length;
            const selected = parseRanges(rangeStr, max);
            for (let i = 1; i <= max; i++) {
                const cb = document.getElementById(`vocab-checkbox-${i}`);
                if (!cb) continue;
                const shouldBeChecked = selected.size === 0 ? true : selected.has(i);
                cb.checked = shouldBeChecked;
                const li = cb.parentElement;
                if (cb.checked) li.classList.remove('disabled'); else li.classList.add('disabled');
            }
        }

        function resetQuiz(useOriginalOrder = false) {
            console.log('Resetting quiz');
            const base = getKanjiDataForLevel(currentLevel) || [];
            let filtered = base.filter((item, idx) => {
                const cb = document.getElementById(`vocab-checkbox-${idx+1}`);
                return cb ? cb.checked : true;
            });
            if (!useOriginalOrder) filtered = shuffle([...filtered]);
            currentKanjiList = filtered;
            currentKanjiIndex = 0;
            lastEndlessOrderKey = getOrderKey(currentKanjiList);
            answerHistory = [];
            correctCount = 0;
            totalCount = 0;
            correctlyAnswered.clear();
            updateHistory();
            updateStats();
            document.getElementById("answer-input").style.display = "block";
            document.getElementById("voice-input-toggle").style.display = "inline-block";
            document.getElementById("speak-now-btn").style.display = isVoiceInputEnabled ? "inline-block" : "none";
            document.getElementById("font-switch").style.display = "inline-block";
            document.getElementById("font-size-control").style.display = "block";
            resetTimer();
            startTimer();
            displayKanji();
        }

        function startQuiz(level, mode) {
            console.log('Starting quiz with level:', level, 'mode:', mode);
            currentLevel = level;
            quizMode = mode;
            isVoiceInputEnabled = document.getElementById("voice-input-toggle-start").checked;
            document.getElementById("voice-input-toggle").checked = isVoiceInputEnabled;
            document.getElementById("speak-now-btn").style.display = isVoiceInputEnabled ? "inline-block" : "none";
            document.getElementById("font-switch").style.display = "inline-block";
            document.getElementById("font-size-control").style.display = "block";
            // build checklist UI and use its checked state for the quiz
            buildVocabList();
            // Reset quiz using default behavior (shuffle)
            resetQuiz(false);
            document.getElementById("level-selector").style.display = "none";
            document.getElementById("main-content").style.display = "flex";
            document.getElementById("sidebar").style.display = "block";
            // show the vocab panel on the far right and add page padding to avoid overlap
            const vp = document.getElementById('vocab-panel');
            if (vp) vp.style.display = 'block';
            document.body.classList.add('vocab-open');
            document.getElementById("difficulty-switch").value = level;
            document.getElementById("mode-switch").value = mode;
            resetTimer();
            startTimer();
            displayKanji();
        }

        // Font switch handling
        document.getElementById("font-switch").addEventListener("change", function() {
            const selectedFont = this.value;
            
            console.log('Font changed to:', selectedFont);
            const kanjiDisplay = document.getElementById("kanji-display");
            kanjiDisplay.classList.remove('marugothic-font', 'mincho-font', 'tegaki-font');
            if (selectedFont === 'marugothic') {
                kanjiDisplay.classList.add('marugothic-font');
            } else if (selectedFont === 'mincho') {
                kanjiDisplay.classList.add('mincho-font');
            } else if (selectedFont === 'tegaki') {
                kanjiDisplay.classList.add('tegaki-font');
            }
        });

        // Apply default font (Mincho) on load.
        document.getElementById("font-switch").dispatchEvent(new Event('change'));

        // Font size control handling
        document.getElementById("increase-font").addEventListener("click", function() {
            fontSize += 20;
            document.getElementById("kanji-display").style.fontSize = `${fontSize}px`;
            console.log('Font size increased to:', fontSize);
        });

        document.getElementById("decrease-font").addEventListener("click", function() {
            fontSize = Math.max(16, fontSize - 4); // Prevent font size from going too small
            document.getElementById("kanji-display").style.fontSize = `${fontSize}px`;
            console.log('Font size decreased to:', fontSize);
        });

        // Voice input handling
        if (recognition) {
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript.trim();
                console.log('Voice input received:', transcript);
                document.getElementById("answer-input").value = transcript;
                document.getElementById("feedback").textContent = "";
                checkAnswer(transcript, true);
            };

            recognition.onerror = function(event) {
                console.error('Voice input error:', event.error);
                document.getElementById("feedback").textContent = "Voice input error: " + event.error;
                document.getElementById("feedback").style.color = "red";
                if (isVoiceInputEnabled) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                            document.getElementById("feedback").textContent = "Listening for Japanese...";
                            document.getElementById("feedback").style.color = "blue";
                        } catch (error) {
                            console.error('Error restarting voice recognition:', error);
                        }
                    }, 500);
                }
            };

            recognition.onend = function() {
                console.log('Voice recognition ended');
                document.getElementById("feedback").textContent = "";
                if (isVoiceInputEnabled && currentKanjiList.length > 0) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                            document.getElementById("feedback").textContent = "Listening for Japanese...";
                            document.getElementById("feedback").style.color = "blue";
                        } catch (error) {
                            console.error('Error restarting voice recognition:', error);
                        }
                    }, 500);
                }
            };

            document.getElementById("voice-input-toggle").addEventListener("change", function() {
                isVoiceInputEnabled = this.checked;
                console.log('Voice input toggle changed:', isVoiceInputEnabled);
                document.getElementById("speak-now-btn").style.display = isVoiceInputEnabled ? "inline-block" : "none";
                if (!isVoiceInputEnabled && recognition) {
                    recognition.stop();
                    document.getElementById("feedback").textContent = "";
                } else if (isVoiceInputEnabled && recognition && currentKanjiList.length > 0) {
                    try {
                        recognition.start();
                        document.getElementById("feedback").textContent = "Listening for Japanese...";
                        document.getElementById("feedback").style.color = "blue";
                    } catch (error) {
                        console.error('Error starting voice recognition:', error);
                    }
                }
            });

            document.getElementById("voice-input-toggle-start").addEventListener("change", function() {
                isVoiceInputEnabled = this.checked;
                console.log('Voice input toggle (start) changed:', isVoiceInputEnabled);
            });

            document.getElementById("speak-now-btn").addEventListener("click", function() {
                if (isVoiceInputEnabled && recognition && currentKanjiList.length > 0) {
                    try {
                        recognition.start();
                        document.getElementById("feedback").textContent = "Listening for Japanese...";
                        document.getElementById("feedback").style.color = "blue";
                        console.log('Manual voice recognition started');
                    } catch (error) {
                        console.error('Error starting voice recognition:', error);
                        document.getElementById("feedback").textContent = "Voice input error: " + error.message;
                        document.getElementById("feedback").style.color = "red";
                    }
                }
            });
        }

        document.getElementById("difficulty-switch").addEventListener("change", function() {
            const selectedLevel = this.value;
            console.log('Difficulty changed to:', selectedLevel);
            startQuiz(selectedLevel, quizMode);
        });

        document.getElementById("mode-switch").addEventListener("change", function() {
            quizMode = this.value;
            console.log('Mode changed to:', quizMode);
            if (quizMode === 'endless' && currentKanjiList.length === 0) {
                reshuffleEndlessCycle();
                document.getElementById("answer-input").style.display = "block";
                document.getElementById("voice-input-toggle").style.display = "inline-block";
                document.getElementById("speak-now-btn").style.display = isVoiceInputEnabled ? "inline-block" : "none";
                document.getElementById("font-switch").style.display = "inline-block";
                document.getElementById("font-size-control").style.display = "block";
                document.getElementById("feedback").textContent = "";
                startTimer();
                displayKanji();
            } else if (quizMode === 'normal' && currentKanjiList.length === 0) {
                const percentage = totalCount > 0 ? (correctCount / totalCount * 100).toFixed(0) : 0.00;
                document.getElementById("kanji-display").textContent = `${percentage}%`;
                document.getElementById("answer-input").style.display = "none";
                document.getElementById("voice-input-toggle").style.display = "none";
                document.getElementById("speak-now-btn").style.display = "none";
                document.getElementById("font-switch").style.display = "none";
                document.getElementById("font-size-control").style.display = "none";
                document.getElementById("feedback").textContent = "Quiz completed!";
                stopTimer();
            }
        });

        document.getElementById("start-btn").addEventListener("click", function() {
            const selectedLevel = document.getElementById("jlpt-level").value;
            const selectedMode = document.getElementById("quiz-mode").value;
            console.log('Start button clicked, level:', selectedLevel, 'mode:', selectedMode);
            startQuiz(selectedLevel, selectedMode);
        });

        // Hook range input Enter to apply filter and reset quiz using original order
        document.getElementById('vocab-range-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const val = this.value.trim();
                applyRangeFilter(val);
                resetQuiz(false);
                const vp = document.getElementById('vocab-panel');
                if (vp) { vp.style.display = 'block'; document.body.classList.add('vocab-open'); }
            }
        });

        document.getElementById("answer-input").addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                if (event.ctrlKey) {
                    event.preventDefault();
                    if (isVoiceInputEnabled && recognition) {
                        recognition.stop();
                        console.log('Voice input stopped due to Ctrl+Enter reset');
                    }
                    resetQuiz();
                    console.log('Quiz reset via Ctrl+Enter (input)');
                    return;
                }
                if (isVoiceInputEnabled && recognition) {
                    recognition.stop();
                    console.log('Voice input stopped due to text input');
                }
                checkAnswer(this.value.trim(), false);
            }
        });

        document.getElementById("theme-toggle").addEventListener("click", function() {
            document.body.classList.toggle("dark-mode");
            this.textContent = document.body.classList.contains("dark-mode") ? 
                "Toggle Light Mode" : "Toggle Dark Mode";
            console.log('Theme toggled, dark-mode:', document.body.classList.contains("dark-mode"));
        });

        document.getElementById("reset-button").addEventListener("click", function() {
            if (isVoiceInputEnabled && recognition) {
                recognition.stop();
                console.log('Voice input stopped due to reset');
            }
            resetQuiz();
        });

        document.getElementById("volume-toggle").addEventListener("click", function() {
            isMuted = !isMuted;
            this.textContent = isMuted ? "Unmute" : "Mute";
            correctSound.volume = isMuted ? 0 : document.getElementById("volume-slider").value;
            wrongSound.volume = isMuted ? 0 : document.getElementById("volume-slider").value;
            console.log('Volume toggle changed, muted:', isMuted);
        });

        document.getElementById("volume-slider").addEventListener("input", function() {
            const volume = this.value;
            correctSound.volume = isMuted ? 0 : volume;
            wrongSound.volume = isMuted ? 0 : volume;
            console.log('Volume slider changed:', volume);
        });
        
        document.addEventListener("keydown", function(event) {
            if (event.key === "Enter" && event.ctrlKey) {
                event.preventDefault();
                if (isVoiceInputEnabled && recognition) {
                    recognition.stop();
                    console.log('Voice input stopped due to Ctrl+Enter reset');
                }
                resetQuiz();
                console.log('Quiz reset via Ctrl+Enter');
                return;
            }
            if (event.key === "Enter" && quizMode === 'normal' && currentKanjiList.length === 0) {
                resetQuiz();
                console.log('Quiz reset via Enter key');
            }
        }, true);

        document.getElementById("main-content").style.display = "none";
        document.getElementById("sidebar").style.display = "none";

        // Basic sanity check so a missing data file fails loudly in console.
        if (!(window.kanjiData && (window.kanjiData.N5 || window.kanjiData.N4 || window.kanjiData.N3))) {
            console.warn('window.kanjiData is missing or empty. Check Data/vocab/n5.js, Data/vocab/n4.js, Data/vocab/n3.js paths.');
        }
    </script>
</body>
</html>